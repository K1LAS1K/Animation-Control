-- Enhanced Animation Control GUI with Search & Better Options
-- By KILASIK - Improved Version

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer

-- Color Palette
local ColorPalette = {
    primary_dark = Color3.fromRGB(40, 40, 40),
    secondary_dark = Color3.fromRGB(50, 50, 50),
    button_inactive = Color3.fromRGB(60, 60, 60),
    button_active = Color3.fromRGB(80, 80, 80),
    button_hover = Color3.fromRGB(70, 70, 70),
    text_primary = Color3.fromRGB(255, 255, 255),
    success = Color3.fromRGB(0, 200, 0),
    error = Color3.fromRGB(200, 0, 0),
    warning = Color3.fromRGB(200, 200, 0),
    discord = Color3.fromRGB(88, 101, 242),
    accent = Color3.fromRGB(100, 100, 100),
    search_bg = Color3.fromRGB(45, 45, 45),
    minimize = Color3.fromRGB(255, 165, 0)
}

-- Variables
local selectedPlayer = nil
local selectedPosition = "Close Front"
local animationPlaying = false
local animationTrack = nil
local followConnection = nil
local playerDropdownOpen = false
local positionDropdownOpen = false
local playerSearchText = ""
local positionSearchText = ""
local isMinimized = false

-- Enhanced Position Options (35+ unique positions)
local positionOptions = {
    -- Basic Positions
    {name = "Close Front", description = "Very close in front of target", offset = Vector3.new(0, 0, -1.5)},
    {name = "Close Behind", description = "Very close behind target", offset = Vector3.new(0, 0, 1.5)},
    {name = "Close Left", description = "Very close to left side", offset = Vector3.new(-1.5, 0, 0)},
    {name = "Close Right", description = "Very close to right side", offset = Vector3.new(1.5, 0, 0)},
    
    -- Distance Variants
    {name = "Far Front", description = "Far in front of target", offset = Vector3.new(0, 0, -4)},
    {name = "Far Behind", description = "Far behind target", offset = Vector3.new(0, 0, 4)},
    {name = "Far Left", description = "Far to the left side", offset = Vector3.new(-4, 0, 0)},
    {name = "Far Right", description = "Far to the right side", offset = Vector3.new(4, 0, 0)},
    
    -- Diagonal Positions
    {name = "Front-Left Diagonal", description = "Front-left diagonal position", offset = Vector3.new(-2, 0, -2)},
    {name = "Front-Right Diagonal", description = "Front-right diagonal position", offset = Vector3.new(2, 0, -2)},
    {name = "Back-Left Diagonal", description = "Back-left diagonal position", offset = Vector3.new(-2, 0, 2)},
    {name = "Back-Right Diagonal", description = "Back-right diagonal position", offset = Vector3.new(2, 0, 2)},
    
    -- Vertical Positions
    {name = "Above Close", description = "Above target (close)", offset = Vector3.new(0, 2, 0)},
    {name = "Above Far", description = "High above target", offset = Vector3.new(0, 5, 0)},
    {name = "Below", description = "Below target", offset = Vector3.new(0, -2, 0)},
    {name = "Above-Front", description = "Above and in front", offset = Vector3.new(0, 3, -2)},
    {name = "Above-Behind", description = "Above and behind", offset = Vector3.new(0, 3, 2)},
    
    -- Special Positions
    {name = "Same Position", description = "Exact same position as target", offset = Vector3.new(0, 0, 0)},
    {name = "Very Close", description = "Extremely close to target", offset = Vector3.new(0, 0, -0.2)},
    {name = "Inside", description = "Inside the target", offset = Vector3.new(0, 0, 0.1)},
    
    -- Compass Positions
    {name = "North", description = "North of target", offset = Vector3.new(0, 0, -3)},
    {name = "South", description = "South of target", offset = Vector3.new(0, 0, 3)},
    {name = "East", description = "East of target", offset = Vector3.new(3, 0, 0)},
    {name = "West", description = "West of target", offset = Vector3.new(-3, 0, 0)},
    {name = "Northeast", description = "Northeast of target", offset = Vector3.new(2.5, 0, -2.5)},
    {name = "Northwest", description = "Northwest of target", offset = Vector3.new(-2.5, 0, -2.5)},
    {name = "Southeast", description = "Southeast of target", offset = Vector3.new(2.5, 0, 2.5)},
    {name = "Southwest", description = "Southwest of target", offset = Vector3.new(-2.5, 0, 2.5)},
    
    -- Advanced Positions
    {name = "Orbital Left", description = "Left orbital position", offset = Vector3.new(-3, 1, -1)},
    {name = "Orbital Right", description = "Right orbital position", offset = Vector3.new(3, 1, -1)},
    {name = "Shadow", description = "Like target's shadow", offset = Vector3.new(0, -0.1, 0.1)},
    {name = "Mirror", description = "Mirror position", offset = Vector3.new(0, 0, -1)},
    {name = "Follow Distance", description = "Ideal distance for following", offset = Vector3.new(-1, 0, 2)},
    {name = "Safe Distance", description = "Safe distance away", offset = Vector3.new(0, 0, -5)},
    {name = "Attack Position", description = "Ideal position for attack", offset = Vector3.new(1, 0, -1.5)},
    {name = "Defense Position", description = "Ideal position for defense", offset = Vector3.new(0, 0, 3)},
    {name = "Observation Point", description = "High point for observation", offset = Vector3.new(0, 4, -3)},
    {name = "Flanking Left", description = "Left flanking position", offset = Vector3.new(-3, 0, -1)},
    {name = "Flanking Right", description = "Right flanking position", offset = Vector3.new(3, 0, -1)}
}

-- GUI Creation
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "KILASIKAnimationGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 380, 0, 520)
mainFrame.Position = UDim2.new(0.5, -190, 0.5, -260)
mainFrame.BackgroundColor3 = ColorPalette.primary_dark
mainFrame.BorderSizePixel = 1
mainFrame.BorderColor3 = Color3.fromRGB(80, 80, 80)
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.ZIndex = 1
mainFrame.Parent = screenGui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 8)
mainCorner.Parent = mainFrame

-- Header
local headerFrame = Instance.new("Frame")
headerFrame.Size = UDim2.new(1, 0, 0, 50)
headerFrame.Position = UDim2.new(0, 0, 0, 0)
headerFrame.BackgroundColor3 = ColorPalette.secondary_dark
headerFrame.BorderSizePixel = 0
headerFrame.Parent = mainFrame

local headerCorner = Instance.new("UICorner")
headerCorner.CornerRadius = UDim.new(0, 8)
headerCorner.Parent = headerFrame

-- KILASIK Branding
local brandLabel = Instance.new("TextLabel")
brandLabel.Size = UDim2.new(1, -70, 0.6, 0)
brandLabel.Position = UDim2.new(0, 10, 0, 0)
brandLabel.BackgroundTransparency = 1
brandLabel.Text = "Enhanced Animation Control - By KILASIK"
brandLabel.TextColor3 = ColorPalette.text_primary
brandLabel.Font = Enum.Font.GothamBold
brandLabel.TextSize = 13
brandLabel.TextXAlignment = Enum.TextXAlignment.Left
brandLabel.Parent = headerFrame

-- Minimize Button
local minimizeButton = Instance.new("TextButton")
minimizeButton.Size = UDim2.new(0, 25, 0, 25)
minimizeButton.Position = UDim2.new(1, -60, 0, 12.5)
minimizeButton.BackgroundColor3 = ColorPalette.minimize
minimizeButton.Text = "_"
minimizeButton.TextColor3 = ColorPalette.text_primary
minimizeButton.Font = Enum.Font.GothamBold
minimizeButton.TextSize = 14
minimizeButton.BorderSizePixel = 0
minimizeButton.Parent = headerFrame

local minimizeCorner = Instance.new("UICorner")
minimizeCorner.CornerRadius = UDim.new(0, 4)
minimizeCorner.Parent = minimizeButton

-- Close Button
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 25, 0, 25)
closeButton.Position = UDim2.new(1, -30, 0, 12.5)
closeButton.BackgroundColor3 = ColorPalette.error
closeButton.Text = "X"
closeButton.TextColor3 = ColorPalette.text_primary
closeButton.Font = Enum.Font.Gotham
closeButton.TextSize = 12
closeButton.BorderSizePixel = 0
closeButton.Parent = headerFrame

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 4)
closeCorner.Parent = closeButton

-- Content Frame
local contentFrame = Instance.new("Frame")
contentFrame.Size = UDim2.new(1, -20, 1, -110)
contentFrame.Position = UDim2.new(0, 10, 0, 60)
contentFrame.BackgroundTransparency = 1
contentFrame.Parent = mainFrame

-- Player Selection Label
local playerLabel = Instance.new("TextLabel")
playerLabel.Size = UDim2.new(1, 0, 0, 25)
playerLabel.Position = UDim2.new(0, 0, 0, 10)
playerLabel.BackgroundTransparency = 1
playerLabel.Text = "Select Target Player:"
playerLabel.TextColor3 = ColorPalette.text_primary
playerLabel.Font = Enum.Font.Gotham
playerLabel.TextSize = 12
playerLabel.TextXAlignment = Enum.TextXAlignment.Left
playerLabel.Parent = contentFrame

-- Player Dropdown
local playerDropdown = Instance.new("TextButton")
playerDropdown.Size = UDim2.new(1, 0, 0, 30)
playerDropdown.Position = UDim2.new(0, 0, 0, 40)
playerDropdown.BackgroundColor3 = ColorPalette.secondary_dark
playerDropdown.Text = "Select a player..."
playerDropdown.TextColor3 = ColorPalette.text_primary
playerDropdown.Font = Enum.Font.Gotham
playerDropdown.TextSize = 12
playerDropdown.BorderSizePixel = 0
playerDropdown.Parent = contentFrame

local playerDropdownCorner = Instance.new("UICorner")
playerDropdownCorner.CornerRadius = UDim.new(0, 4)
playerDropdownCorner.Parent = playerDropdown

-- Player Dropdown Arrow
local playerArrow = Instance.new("TextLabel")
playerArrow.Size = UDim2.new(0, 20, 1, 0)
playerArrow.Position = UDim2.new(1, -25, 0, 0)
playerArrow.BackgroundTransparency = 1
playerArrow.Text = "â–¼"
playerArrow.TextColor3 = ColorPalette.text_primary
playerArrow.Font = Enum.Font.Gotham
playerArrow.TextSize = 10
playerArrow.Parent = playerDropdown

-- Player List Frame
local playerListFrame = Instance.new("ScrollingFrame")
playerListFrame.Size = UDim2.new(1, 0, 0, 120)
playerListFrame.Position = UDim2.new(0, 0, 0, 75)
playerListFrame.BackgroundColor3 = ColorPalette.accent
playerListFrame.BorderSizePixel = 1
playerListFrame.BorderColor3 = Color3.fromRGB(80, 80, 80)
playerListFrame.ScrollBarThickness = 4
playerListFrame.Visible = false
playerListFrame.ZIndex = 10
playerListFrame.Parent = screenGui

local playerListCorner = Instance.new("UICorner")
playerListCorner.CornerRadius = UDim.new(0, 4)
playerListCorner.Parent = playerListFrame

local playerListLayout = Instance.new("UIListLayout")
playerListLayout.SortOrder = Enum.SortOrder.Name
playerListLayout.Padding = UDim.new(0, 2)
playerListLayout.Parent = playerListFrame

-- Position Selection Label
local positionLabel = Instance.new("TextLabel")
positionLabel.Size = UDim2.new(1, 0, 0, 25)
positionLabel.Position = UDim2.new(0, 0, 0, 85)
positionLabel.BackgroundTransparency = 1
positionLabel.Text = "Select Position Relative to Target:"
positionLabel.TextColor3 = ColorPalette.text_primary
positionLabel.Font = Enum.Font.Gotham
positionLabel.TextSize = 12
positionLabel.TextXAlignment = Enum.TextXAlignment.Left
positionLabel.Parent = contentFrame

-- Position Dropdown
local positionDropdown = Instance.new("TextButton")
positionDropdown.Size = UDim2.new(1, 0, 0, 30)
positionDropdown.Position = UDim2.new(0, 0, 0, 115)
positionDropdown.BackgroundColor3 = ColorPalette.secondary_dark
positionDropdown.Text = "Close Front - Very close in front of target"
positionDropdown.TextColor3 = ColorPalette.text_primary
positionDropdown.Font = Enum.Font.Gotham
positionDropdown.TextSize = 12
positionDropdown.BorderSizePixel = 0
positionDropdown.Parent = contentFrame

local positionDropdownCorner = Instance.new("UICorner")
positionDropdownCorner.CornerRadius = UDim.new(0, 4)
positionDropdownCorner.Parent = positionDropdown

-- Position Dropdown Arrow
local positionArrow = Instance.new("TextLabel")
positionArrow.Size = UDim2.new(0, 20, 1, 0)
positionArrow.Position = UDim2.new(1, -25, 0, 0)
positionArrow.BackgroundTransparency = 1
positionArrow.Text = "â–¼"
positionArrow.TextColor3 = ColorPalette.text_primary
positionArrow.Font = Enum.Font.Gotham
positionArrow.TextSize = 10
positionArrow.Parent = positionDropdown

-- Position List Frame
local positionListFrame = Instance.new("ScrollingFrame")
positionListFrame.Size = UDim2.new(1, 0, 0, 160)
positionListFrame.Position = UDim2.new(0, 0, 0, 225)
positionListFrame.BackgroundColor3 = ColorPalette.accent
positionListFrame.BorderSizePixel = 1
positionListFrame.BorderColor3 = Color3.fromRGB(80, 80, 80)
positionListFrame.ScrollBarThickness = 4
positionListFrame.Visible = false
positionListFrame.ZIndex = 10
positionListFrame.Parent = screenGui

local positionListCorner = Instance.new("UICorner")
positionListCorner.CornerRadius = UDim.new(0, 4)
positionListCorner.Parent = positionListFrame

local positionListLayout = Instance.new("UIListLayout")
positionListLayout.SortOrder = Enum.SortOrder.LayoutOrder
positionListLayout.Padding = UDim.new(0, 2)
positionListLayout.Parent = positionListFrame

-- Animation ID Label
local animLabel = Instance.new("TextLabel")
animLabel.Size = UDim2.new(1, 0, 0, 25)
animLabel.Position = UDim2.new(0, 0, 0, 160)
animLabel.BackgroundTransparency = 1
animLabel.Text = "Animation ID:"
animLabel.TextColor3 = ColorPalette.text_primary
animLabel.Font = Enum.Font.Gotham
animLabel.TextSize = 12
animLabel.TextXAlignment = Enum.TextXAlignment.Left
animLabel.Parent = contentFrame

-- Animation ID Input
local animInput = Instance.new("TextBox")
animInput.Size = UDim2.new(1, 0, 0, 30)
animInput.Position = UDim2.new(0, 0, 0, 190)
animInput.BackgroundColor3 = ColorPalette.secondary_dark
animInput.Text = ""
animInput.PlaceholderText = "Enter animation ID..."
animInput.TextColor3 = ColorPalette.text_primary
animInput.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
animInput.Font = Enum.Font.Gotham
animInput.TextSize = 12
animInput.BorderSizePixel = 0
animInput.Parent = contentFrame

local animInputCorner = Instance.new("UICorner")
animInputCorner.CornerRadius = UDim.new(0, 4)
animInputCorner.Parent = animInput

-- Speed Label
local speedLabel = Instance.new("TextLabel")
speedLabel.Size = UDim2.new(1, 0, 0, 25)
speedLabel.Position = UDim2.new(0, 0, 0, 235)
speedLabel.BackgroundTransparency = 1
speedLabel.Text = "Animation Speed:"
speedLabel.TextColor3 = ColorPalette.text_primary
speedLabel.Font = Enum.Font.Gotham
speedLabel.TextSize = 12
speedLabel.TextXAlignment = Enum.TextXAlignment.Left
speedLabel.Parent = contentFrame

-- Speed Input
local speedInput = Instance.new("TextBox")
speedInput.Size = UDim2.new(1, 0, 0, 30)
speedInput.Position = UDim2.new(0, 0, 0, 265)
speedInput.BackgroundColor3 = ColorPalette.secondary_dark
speedInput.Text = "1.0"
speedInput.PlaceholderText = "Speed (1.0 = normal)"
speedInput.TextColor3 = ColorPalette.text_primary
speedInput.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
speedInput.Font = Enum.Font.Gotham
speedInput.TextSize = 12
speedInput.BorderSizePixel = 0
speedInput.Parent = contentFrame

local speedInputCorner = Instance.new("UICorner")
speedInputCorner.CornerRadius = UDim.new(0, 4)
speedInputCorner.Parent = speedInput

-- Control Buttons
local startButton = Instance.new("TextButton")
startButton.Size = UDim2.new(0.48, 0, 0, 35)
startButton.Position = UDim2.new(0, 0, 0, 310)
startButton.BackgroundColor3 = ColorPalette.success
startButton.Text = "Start Animation"
startButton.TextColor3 = ColorPalette.text_primary
startButton.Font = Enum.Font.GothamBold
startButton.TextSize = 11
startButton.BorderSizePixel = 0
startButton.Parent = contentFrame

local startCorner = Instance.new("UICorner")
startCorner.CornerRadius = UDim.new(0, 4)
startCorner.Parent = startButton

local stopButton = Instance.new("TextButton")
stopButton.Size = UDim2.new(0.48, 0, 0, 35)
stopButton.Position = UDim2.new(0.52, 0, 0, 310)
stopButton.BackgroundColor3 = ColorPalette.error
stopButton.Text = "Stop"
stopButton.TextColor3 = ColorPalette.text_primary
stopButton.Font = Enum.Font.GothamBold
stopButton.TextSize = 12
stopButton.BorderSizePixel = 0
stopButton.Parent = contentFrame

local stopCorner = Instance.new("UICorner")
stopCorner.CornerRadius = UDim.new(0, 4)
stopCorner.Parent = stopButton

-- Discord Frame
local discordFrame = Instance.new("TextButton")
discordFrame.Size = UDim2.new(1, -20, 0, 35)
discordFrame.Position = UDim2.new(0, 10, 1, -45)
discordFrame.BackgroundColor3 = ColorPalette.discord
discordFrame.BorderSizePixel = 0
discordFrame.Text = "Discord: https://discord.gg/PHxN8nadgk"
discordFrame.TextColor3 = ColorPalette.text_primary
discordFrame.Font = Enum.Font.Gotham
discordFrame.TextSize = 11
discordFrame.Parent = mainFrame

local discordCorner = Instance.new("UICorner")
discordCorner.CornerRadius = UDim.new(0, 4)
discordCorner.Parent = discordFrame



-- Functions
local function updatePlayerList()
    for _, child in pairs(playerListFrame:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    local players = Players:GetPlayers()
    local filteredPlayers = {}
    
    for _, p in pairs(players) do
        if p ~= player then
            table.insert(filteredPlayers, p)
        end
    end
    
    playerListFrame.CanvasSize = UDim2.new(0, 0, 0, #filteredPlayers * 32)
    
    -- Update position relative to main frame
    local mainFramePos = mainFrame.AbsolutePosition
    local dropdownPos = playerDropdown.AbsolutePosition
    playerListFrame.Position = UDim2.new(0, dropdownPos.X, 0, dropdownPos.Y + 35)
    playerListFrame.Size = UDim2.new(0, playerDropdown.AbsoluteSize.X, 0, 120)
    
    for i, p in pairs(filteredPlayers) do
        local playerButton = Instance.new("TextButton")
        playerButton.Size = UDim2.new(1, -8, 0, 30)
        playerButton.Position = UDim2.new(0, 4, 0, 0)
        playerButton.BackgroundColor3 = ColorPalette.button_inactive
        playerButton.Text = p.Name
        playerButton.TextColor3 = ColorPalette.text_primary
        playerButton.Font = Enum.Font.Gotham
        playerButton.TextSize = 11
        playerButton.BorderSizePixel = 0
        playerButton.ZIndex = 11
        playerButton.Parent = playerListFrame
        
        local buttonCorner = Instance.new("UICorner")
        buttonCorner.CornerRadius = UDim.new(0, 3)
        buttonCorner.Parent = playerButton
        
        playerButton.MouseButton1Click:Connect(function()
            selectedPlayer = p
            playerDropdown.Text = p.Name
            playerListFrame.Visible = false
            playerDropdownOpen = false
            playerArrow.Text = "â–¼"
        end)
        
        playerButton.MouseEnter:Connect(function()
            playerButton.BackgroundColor3 = ColorPalette.button_hover
        end)
        
        playerButton.MouseLeave:Connect(function()
            playerButton.BackgroundColor3 = ColorPalette.button_inactive
        end)
    end
end

local function createPositionList()
    for _, child in pairs(positionListFrame:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    positionListFrame.CanvasSize = UDim2.new(0, 0, 0, #positionOptions * 32)
    
    -- Update position relative to main frame
    local dropdownPos = positionDropdown.AbsolutePosition
    positionListFrame.Position = UDim2.new(0, dropdownPos.X, 0, dropdownPos.Y + 35)
    positionListFrame.Size = UDim2.new(0, positionDropdown.AbsoluteSize.X, 0, 160)
    
    for i, pos in pairs(positionOptions) do
        local posButton = Instance.new("TextButton")
        posButton.Size = UDim2.new(1, -8, 0, 30)
        posButton.Position = UDim2.new(0, 4, 0, 0)
        posButton.BackgroundColor3 = ColorPalette.button_inactive
        posButton.Text = pos.name .. " - " .. pos.description
        posButton.TextColor3 = ColorPalette.text_primary
        posButton.Font = Enum.Font.Gotham
        posButton.TextSize = 10
        posButton.BorderSizePixel = 0
        posButton.ZIndex = 11
        posButton.TextTruncate = Enum.TextTruncate.AtEnd
        posButton.Parent = positionListFrame
        
        local buttonCorner = Instance.new("UICorner")
        buttonCorner.CornerRadius = UDim.new(0, 3)
        buttonCorner.Parent = posButton
        
        posButton.MouseButton1Click:Connect(function()
            selectedPosition = pos.name
            positionDropdown.Text = pos.name .. " - " .. pos.description
            positionListFrame.Visible = false
            positionDropdownOpen = false
            positionArrow.Text = "â–¼"
        end)
        
        posButton.MouseEnter:Connect(function()
            posButton.BackgroundColor3 = ColorPalette.button_hover
        end)
        
        posButton.MouseLeave:Connect(function()
            posButton.BackgroundColor3 = ColorPalette.button_inactive
        end)
    end
end

local function getPositionOffset(positionName)
    for _, pos in pairs(positionOptions) do
        if pos.name == positionName then
            return pos.offset
        end
    end
    return Vector3.new(0, 0, -2) -- Default
end

local function startAnimation()
    if not selectedPlayer or not selectedPlayer.Character then
        return
    end
    
    local animId = animInput.Text
    if animId == "" then
        return
    end
    
    local speed = tonumber(speedInput.Text) or 1.0
    
    -- Stop previous animation
    if animationTrack then
        animationTrack:Stop()
        animationTrack = nil
    end
    
    -- Stop previous follow connection
    if followConnection then
        followConnection:Disconnect()
        followConnection = nil
    end
    
    local humanoid = player.Character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    local animation = Instance.new("Animation")
    animation.AnimationId = "rbxassetid://" .. animId
    
    animationTrack = humanoid:LoadAnimation(animation)
    animationTrack:Play()
    animationTrack:AdjustSpeed(speed)
    
    animationPlaying = true
    
    -- Follow target with relative positioning and animation protection
    followConnection = RunService.Heartbeat:Connect(function()
        if not animationPlaying then
            return
        end
        
        -- Check if character exists
        if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") or not player.Character:FindFirstChild("Humanoid") then
            return
        end
        
        local humanoid = player.Character:FindFirstChild("Humanoid")
        
        -- Restart animation if it was stopped (due to damage/stun)
        if animationTrack and not animationTrack.IsPlaying then
            animationTrack:Play()
            animationTrack:AdjustSpeed(speed)
        end
        
        -- Prevent state changes that stop animations
        if humanoid.PlatformStand then
            humanoid.PlatformStand = false
        end
        
        -- Reset humanoid state if it gets changed
        if humanoid:GetState() ~= Enum.HumanoidStateType.Running and 
           humanoid:GetState() ~= Enum.HumanoidStateType.RunningNoPhysics then
            humanoid:ChangeState(Enum.HumanoidStateType.RunningNoPhysics)
        end
        
        -- Position relative to target
        if selectedPlayer and selectedPlayer.Character and selectedPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local targetRootPart = selectedPlayer.Character.HumanoidRootPart
            local targetCFrame = targetRootPart.CFrame
            local offset = getPositionOffset(selectedPosition)
            
            -- Calculate position relative to target's orientation
            local relativePos = targetCFrame:PointToWorldSpace(offset)
            
            -- Keep your character facing the same direction as target or face target depending on position
            local newCFrame
            if selectedPosition == "Same Position" or selectedPosition == "Very Close" or selectedPosition == "Inside" then
                -- Face same direction as target
                newCFrame = CFrame.new(relativePos, relativePos + targetCFrame.LookVector)
            else
                -- Face toward target
                newCFrame = CFrame.new(relativePos, targetRootPart.Position)
            end
            
            player.Character.HumanoidRootPart.CFrame = newCFrame
            
            -- Ensure velocity is reset to prevent physics interference
            if player.Character.HumanoidRootPart:FindFirstChild("BodyVelocity") then
                player.Character.HumanoidRootPart.BodyVelocity:Destroy()
            end
            player.Character.HumanoidRootPart.Velocity = Vector3.new(0, 0, 0)
        end
    end)
end

local function stopAnimation()
    if animationTrack then
        animationTrack:Stop()
        animationTrack = nil
    end
    
    if followConnection then
        followConnection:Disconnect()
        followConnection = nil
    end
    
    animationPlaying = false
end

-- Minimize/Maximize functionality
local function toggleMinimize()
    isMinimized = not isMinimized
    
    if isMinimized then
        -- Minimize
        mainFrame:TweenSize(
            UDim2.new(0, 380, 0, 50),
            Enum.EasingDirection.Out,
            Enum.EasingStyle.Quad,
            0.3,
            true
        )
        contentFrame.Visible = false
        discordFrame.Visible = false
        minimizeButton.Text = "â–¡"
    else
        -- Maximize
        mainFrame:TweenSize(
            UDim2.new(0, 380, 0, 520),
            Enum.EasingDirection.Out,
            Enum.EasingStyle.Quad,
            0.3,
            true
        )
        contentFrame.Visible = true
        discordFrame.Visible = true
        minimizeButton.Text = "_"
    end
end

-- Event Connections

playerDropdown.MouseButton1Click:Connect(function()
    playerDropdownOpen = not playerDropdownOpen
    playerListFrame.Visible = playerDropdownOpen
    playerArrow.Text = playerDropdownOpen and "â–²" or "â–¼"
    
    if playerDropdownOpen then
        updatePlayerList()
    end
end)

positionDropdown.MouseButton1Click:Connect(function()
    positionDropdownOpen = not positionDropdownOpen
    positionListFrame.Visible = positionDropdownOpen
    positionArrow.Text = positionDropdownOpen and "â–²" or "â–¼"
    
    if positionDropdownOpen then
        createPositionList()
    end
end)

startButton.MouseButton1Click:Connect(startAnimation)
stopButton.MouseButton1Click:Connect(stopAnimation)

minimizeButton.MouseButton1Click:Connect(toggleMinimize)

closeButton.MouseButton1Click:Connect(function()
    stopAnimation()
    screenGui:Destroy()
end)

discordFrame.MouseButton1Click:Connect(function()
    setclipboard("https://discord.gg/PHxN8nadgk")
end)

-- Click outside to close dropdowns
UserInputService.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        local mouse = Players.LocalPlayer:GetMouse()
        local mousePos = Vector2.new(mouse.X, mouse.Y)
        
        -- Check if clicked outside player dropdown
        if playerDropdownOpen then
            local playerFramePos = playerListFrame.AbsolutePosition
            local playerFrameSize = playerListFrame.AbsoluteSize
            
            if mousePos.X < playerFramePos.X or mousePos.X > playerFramePos.X + playerFrameSize.X or
               mousePos.Y < playerFramePos.Y or mousePos.Y > playerFramePos.Y + playerFrameSize.Y then
                
                local dropdownPos = playerDropdown.AbsolutePosition
                local dropdownSize = playerDropdown.AbsoluteSize
                
                if mousePos.X < dropdownPos.X or mousePos.X > dropdownPos.X + dropdownSize.X or
                   mousePos.Y < dropdownPos.Y or mousePos.Y > dropdownPos.Y + dropdownSize.Y then
                    
                    playerListFrame.Visible = false
                    playerDropdownOpen = false
                    playerArrow.Text = "â–¼"
                end
            end
        end
        
        -- Check if clicked outside position dropdown
        if positionDropdownOpen then
            local positionFramePos = positionListFrame.AbsolutePosition
            local positionFrameSize = positionListFrame.AbsoluteSize
            
            if mousePos.X < positionFramePos.X or mousePos.X > positionFramePos.X + positionFrameSize.X or
               mousePos.Y < positionFramePos.Y or mousePos.Y > positionFramePos.Y + positionFrameSize.Y then
                
                local dropdownPos = positionDropdown.AbsolutePosition
                local dropdownSize = positionDropdown.AbsoluteSize
                
                if mousePos.X < dropdownPos.X or mousePos.X > dropdownPos.X + dropdownSize.X or
                   mousePos.Y < dropdownPos.Y or mousePos.Y > dropdownPos.Y + dropdownSize.Y then
                    
                    positionListFrame.Visible = false
                    positionDropdownOpen = false
                    positionArrow.Text = "â–¼"
                end
            end
        end
    end
end)

-- Player list update when players join/leave
Players.PlayerAdded:Connect(function()
    if playerDropdownOpen then
        updatePlayerList()
    end
end)

Players.PlayerRemoving:Connect(function()
    if playerDropdownOpen then
        updatePlayerList()
    end
end)

-- Initialize
createPositionList()
updatePlayerList()
